# 월 갱신 자동화 설정 가이드

## 🎯 기능 개요
매월 자동으로 결제일이 지난 회원들의 정보를 업데이트하는 시스템입니다.

### 업데이트 로직
- **대상**: 지난 달에 결제일이 있었고, 그 날짜가 현재 날짜보다 작거나 같은 회원
- **조건**: 입금 상태가 'completed'가 아닌 회원 (대기 또는 실패 상태)
- **변경사항**: 
  - 결제일 → 다음 달 같은 날짜
  - 입금 상태 → 'pending' (대기)

### 예시
- 현재 날짜: 11월 5일
- 10월 5일이 결제일인 회원 → 11월 5일로 변경
- 12월 5일이 결제일인 회원 → 변경 없음 (아직 결제일이 지나지 않음)

## 🔧 수동 실행 방법
1. 관리자 대시보드 로그인
2. "월 갱신" 버튼 클릭
3. 업데이트 대상 회원 확인
4. "월 갱신 실행" 버튼으로 실행

## ⚙️ 자동화 설정 옵션

### 1. Vercel Cron Jobs (추천)
Vercel의 내장 Cron Jobs 기능을 사용하여 자동화할 수 있습니다.

```typescript
// app/api/cron/monthly-update/route.ts
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  // Vercel Cron Secret 검증
  const authHeader = request.headers.get('authorization');
  if (authHeader !== \`Bearer \${process.env.CRON_SECRET}\`) {
    return new Response('Unauthorized', { status: 401 });
  }

  try {
    // 월 갱신 로직 실행
    const response = await fetch(\`\${process.env.NEXTAUTH_URL}/api/admin/monthly-update\`, {
      method: 'POST',
    });
    
    const result = await response.json();
    return NextResponse.json(result);
  } catch (error) {
    return NextResponse.json({ error: 'Cron job failed' }, { status: 500 });
  }
}
```

**vercel.json 설정:**
```json
{
  "crons": [
    {
      "path": "/api/cron/monthly-update",
      "schedule": "0 9 * * *"
    }
  ]
}
```

### 2. GitHub Actions
```yaml
# .github/workflows/monthly-update.yml
name: Monthly Update

on:
  schedule:
    - cron: '0 9 * * *'  # 매일 오전 9시 실행
  workflow_dispatch:  # 수동 실행 가능

jobs:
  monthly-update:
    runs-on: ubuntu-latest
    steps:
      - name: Call Monthly Update API
        run: |
          curl -X POST \
            -H "Authorization: Bearer \${{ secrets.API_SECRET }}" \
            \${{ secrets.SITE_URL }}/api/admin/monthly-update
```

### 3. 외부 Cron 서비스
- **Uptime Robot**: 웹사이트 모니터링과 함께 HTTP 요청 가능
- **Cronhub**: 전용 Cron 서비스
- **EasyCron**: 무료 Cron 서비스

**설정 예시:**
- URL: https://your-site.com/api/admin/monthly-update
- Method: POST
- 스케줄: 매일 오전 9시
- Headers: Authorization: Bearer YOUR_SECRET

## 🔒 보안 고려사항

### API 보호
월 갱신 API에 인증을 추가하는 것을 권장합니다:

```typescript
// app/api/admin/monthly-update/route.ts 수정
export async function POST(request: NextRequest) {
  // API 키 검증
  const apiKey = request.headers.get('authorization');
  if (apiKey !== \`Bearer \${process.env.MONTHLY_UPDATE_SECRET}\`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }
  
  // 기존 로직...
}
```

### 환경변수 설정
```bash
# .env.local
MONTHLY_UPDATE_SECRET=your-secret-key-here
CRON_SECRET=your-cron-secret-here
```

## 📊 모니터링

### 로그 확인
- Vercel Dashboard에서 Function Logs 확인
- 업데이트된 회원 수와 상세 정보 로그

### 알림 설정
Discord/Slack 웹훅을 통한 결과 알림도 추가할 수 있습니다:

```typescript
// 월 갱신 완료 후 알림
const sendNotification = async (result: any) => {
  await fetch(process.env.DISCORD_WEBHOOK_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      content: \`월 갱신 완료: \${result.updatedCount}명 업데이트됨\`
    })
  });
};
```

## 🚀 권장 설정
1. **Vercel Cron Jobs** 사용 (가장 간단)
2. **매일 오전 9시** 실행
3. **API 인증** 추가
4. **Discord/Slack 알림** 설정
5. **수동 실행** 옵션 유지

이렇게 설정하면 매월 자동으로 회원들의 결제일과 입금 상태가 업데이트됩니다.